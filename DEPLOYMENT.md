# Deployment Guide - Render

This guide explains how to deploy the Lovable e-commerce application to Render.

## Prerequisites

1. A Render account (sign up at https://render.com)
2. Your code pushed to a Git repository (GitHub, GitLab, or Bitbucket)

## Deployment Steps

### Option 1: Using render.yaml (Recommended)

1. **Push your code to GitHub**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. **Create a New Blueprint on Render**
   - Go to https://dashboard.render.com
   - Click "New" → "Blueprint"
   - Connect your Git repository
   - Render will automatically detect `render.yaml` and create:
     - PostgreSQL database
     - Django backend service
     - React frontend static site

3. **Set Environment Variables**
   
   The following will be auto-generated:
   - `SECRET_KEY` - Auto-generated by Render
   - `DATABASE_URL` - Auto-configured from PostgreSQL service
   
   You need to set manually in the Render dashboard:
   - `ALLOWED_HOSTS` - Your backend URL (e.g., `lovable-backend.onrender.com`)
   - `CORS_ALLOWED_ORIGINS` - Your frontend URL (e.g., `https://lovable-frontend.onrender.com`)

4. **Update Frontend API URL**
   
   After deployment, update your frontend to use the production API:
   
   In `src/lib/api.ts`, change:
   ```typescript
   const API_URL = import.meta.env.VITE_API_URL || 'https://lovable-backend.onrender.com/api';
   ```

### Option 2: Manual Deployment

#### Backend Service

1. **Create Web Service**
   - Go to Render Dashboard
   - Click "New" → "Web Service"
   - Connect your repository
   - Configure:
     - **Name**: lovable-backend
     - **Root Directory**: backend
     - **Build Command**: `./build.sh`
     - **Start Command**: `gunicorn config.wsgi:application`
     - **Instance Type**: Free or Starter

2. **Create PostgreSQL Database**
   - Click "New" → "PostgreSQL"
   - Configure:
     - **Name**: lovable-db
     - **Database**: lovable
     - **User**: lovable
     - **Region**: Same as your web service
   - Copy the Internal Database URL

3. **Set Environment Variables** (in Web Service settings)
   ```
   SECRET_KEY=<generate-random-key>
   DEBUG=False
   DATABASE_URL=<paste-internal-database-url>
   ALLOWED_HOSTS=lovable-backend.onrender.com
   CORS_ALLOWED_ORIGINS=https://lovable-frontend.onrender.com
   TZ=UTC
   PYTHON_VERSION=3.14.2
   ```

#### Frontend Service

1. **Create Static Site**
   - Click "New" → "Static Site"
   - Connect your repository
   - Configure:
     - **Name**: lovable-frontend
     - **Build Command**: `npm install && npm run build`
     - **Publish Directory**: dist

2. **Set Environment Variables**
   ```
   VITE_API_URL=https://lovable-backend.onrender.com/api
   NODE_VERSION=18
   ```

## Post-Deployment

### 1. Create Admin User

Connect to your backend service shell and create a superuser:

```bash
python manage.py createsuperuser
```

### 2. Upload Media Files

Since Render uses ephemeral storage, consider using:
- **Cloudinary** for image hosting
- **AWS S3** for file storage
- **Render Disks** (paid feature) for persistent storage

### 3. Configure Custom Domain (Optional)

1. In Render Dashboard → Your service → Settings → Custom Domains
2. Add your domain
3. Update DNS records as instructed
4. Update `ALLOWED_HOSTS` and `CORS_ALLOWED_ORIGINS`

## Environment Variables Reference

### Backend (.env for local, Render dashboard for production)

| Variable | Description | Example |
|----------|-------------|---------|
| `SECRET_KEY` | Django secret key | Auto-generated |
| `DEBUG` | Debug mode | `False` for production |
| `DATABASE_URL` | PostgreSQL connection | Auto-configured |
| `ALLOWED_HOSTS` | Allowed hostnames | `lovable-backend.onrender.com` |
| `CORS_ALLOWED_ORIGINS` | CORS origins | `https://lovable-frontend.onrender.com` |
| `TZ` | Timezone | `Asia/Tashkent` or `UTC` |

### Frontend

| Variable | Description | Example |
|----------|-------------|---------|
| `VITE_API_URL` | Backend API URL | `https://lovable-backend.onrender.com/api` |

## Troubleshooting

### Build Fails

1. Check build logs in Render dashboard
2. Verify `requirements.txt` has all dependencies
3. Ensure `build.sh` is executable: `chmod +x backend/build.sh`

### Database Connection Error

1. Verify `DATABASE_URL` is set correctly
2. Check PostgreSQL service is running
3. Ensure backend and database are in the same region

### Static Files Not Loading

1. Run `python manage.py collectstatic` in build script (already included)
2. Verify `STATIC_ROOT` and `STATIC_URL` settings
3. Check WhiteNoise is installed and configured

### CORS Errors

1. Update `CORS_ALLOWED_ORIGINS` with your frontend URL
2. Include `https://` in the URL
3. Restart backend service after changes

### Images Not Displaying

For production, you need persistent storage:

**Option 1: Use Cloudinary**
```bash
pip install cloudinary django-cloudinary-storage
```

Update settings.py:
```python
CLOUDINARY_STORAGE = {
    'CLOUD_NAME': config('CLOUDINARY_CLOUD_NAME'),
    'API_KEY': config('CLOUDINARY_API_KEY'),
    'API_SECRET': config('CLOUDINARY_API_SECRET'),
}
DEFAULT_FILE_STORAGE = 'cloudinary_storage.storage.MediaCloudinaryStorage'
```

**Option 2: Use Render Disks**
- Paid feature
- Add disk in Render dashboard
- Mount at `/opt/render/project/src/backend/media`

## Performance Tips

1. **Use CDN**: Serve static files through Cloudflare or similar
2. **Enable Caching**: Configure browser caching headers
3. **Database Indexing**: Add indexes to frequently queried fields
4. **Upgrade Instance**: Move from Free to Starter tier for better performance
5. **Connection Pooling**: Configure PostgreSQL connection pooling

## Monitoring

1. **Logs**: View real-time logs in Render dashboard
2. **Metrics**: Monitor CPU, memory, and request metrics
3. **Alerts**: Set up email alerts for service failures
4. **Uptime**: Use UptimeRobot or similar for monitoring

## Backup

1. **Database**: Render provides automatic backups for paid plans
2. **Manual Backup**: Use `pg_dump` to export database:
   ```bash
   pg_dump $DATABASE_URL > backup.sql
   ```

## Cost Estimate

- **Free Tier**:
  - Backend: Free (spins down after inactivity)
  - Frontend: Free
  - Database: Free (expires after 90 days)

- **Paid Tier**:
  - Backend: $7/month (Starter)
  - Frontend: Free
  - Database: $7/month (Starter)
  - Total: ~$14/month

## Support

- Render Docs: https://render.com/docs
- Django Deployment: https://docs.djangoproject.com/en/stable/howto/deployment/
- Contact: support@render.com
